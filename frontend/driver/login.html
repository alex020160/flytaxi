<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Вход — FlyTaxi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/assets/css/fonts.css" />
    <link rel="stylesheet" href="/assets/css/main.css" />
</head>
<body class="page page--centered">
<div class="login-box">
    <h1 class="login-title">Вход</h1>

    <form id="driverLoginForm" class="login-form">
        <div class="input-group">
            <input
                    class="input"
                    name="identifier"
                    placeholder="Телефон или Email"
                    required
            />
        </div>
        <div class="input-group">
            <input
                    class="input"
                    type="password"
                    name="password"
                    placeholder="Пароль"
                    required
            />
        </div>

        <button type="submit" class="btn btn--driver" style="width: 100%;">
            Войти
        </button>

        <div id="driverLoginMessage" class="login-info"></div>
    </form>

    <div class="login-links">
        <a class="login-back" href="/driver/register.html">Зарегистрироваться</a>
        <a class="login-back" href="/driver/forgot-password.html">Забыли пароль?</a>
        <a class="login-back" href="/">← На главную</a>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem("ft_access_token");
      const user = JSON.parse(localStorage.getItem("ft_user") || "{}");
      if (token && user.role === "driver") {
        window.location.href = "/driver/dashboard.html";
        return;
      }

      const form = document.getElementById("driverLoginForm");
      const message = document.getElementById("driverLoginMessage");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const identifier = form.identifier.value.trim();
        const password = form.password.value;

        message.textContent = "Входим...";
        message.style.color = "#e5e7eb";

        try {
          const res = await fetch("/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ identifier, password }),
          });

          const json = await res.json().catch(() => ({}));
          console.log("driver login response:", json);

          if (!res.ok) {
            message.textContent = "Ошибка авторизации";
            message.style.color = "#ef4444";
            return;
          }

          localStorage.setItem("ft_access_token", json.access_token);
          localStorage.setItem("ft_user", JSON.stringify(json.user));

          if (json.user.role !== "driver") {
            message.textContent = "Этот аккаунт не является аккаунтом водителя";
            message.style.color = "#ef4444";
            localStorage.removeItem("ft_access_token");
            localStorage.removeItem("ft_user");
            return;
          }

          message.textContent = "Успешный вход, перенаправляем...";
          message.style.color = "#22c55e";

          setTimeout(() => {
            window.location.href = "/driver/dashboard.html";
          }, 600);
        } catch (err) {
          console.error(err);
          message.textContent = "Ошибка сети при входе";
          message.style.color = "#ef4444";
        }
      });
    });
</script>
</body>
</html>
