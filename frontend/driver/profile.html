<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Личный кабинет водителя — FlyTaxi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/assets/css/fonts.css">
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body class="page profile-page">
<div class="profile-layout">
    <div class="profile-topbar">
        <div class="profile-topbar__title">FlyTaxi — Водитель</div>
        <div class="profile-topbar__actions">
            <a href="/driver/dashboard.html" class="btn btn--ghost btn--small">← К заказам</a>
            <button id="logoutBtn" class="btn btn--ghost btn--small">Выйти</button>
        </div>
    </div>

    <section class="card card--wide profile-card-shell">
        <h1 class="card__title">Личный кабинет водителя</h1>

        <div id="driverProfileError" class="login-info" style="margin-bottom:8px;"></div>

        <div class="profile-grid">
            <!-- Профиль и авто -->
            <div class="profile-card">
                <h2 class="profile-card__title">Профиль</h2>
                <div id="driverProfileInfo" class="profile-card__body"></div>
            </div>

            <div class="profile-card">
                <h2 class="profile-card__title">Автомобиль</h2>
                <div id="driverCarInfo" class="profile-card__body"></div>
            </div>

            <!-- Статистика -->
            <div class="profile-card">
                <h2 class="profile-card__title">Статистика поездок</h2>
                <div id="driverStats" class="stats-grid"></div>
            </div>

            <!-- Последние выполненные заказы -->
            <div class="profile-card profile-card--wide">
                <h2 class="profile-card__title">Последние завершённые поездки</h2>
                <div id="driverTrips" class="history-list"></div>
            </div>
        </div>
    </section>
</div>

<script>
    document.addEventListener("DOMContentLoaded", initDriverProfile);

    // общий safeFetch для водительских страниц
    async function safeFetch(url, options) {
        const res = await fetch(url, options);

        if (res.status === 401) {
            localStorage.removeItem("ft_access_token");
            localStorage.removeItem("ft_user");
            window.location.href = "/driver/login.html";
            return null;
        }

        return res;
    }

    async function initDriverProfile() {
        const token = localStorage.getItem("ft_access_token");
        const user  = JSON.parse(localStorage.getItem("ft_user") || "{}");

        if (!token || user.role !== "driver") {
            window.location.href = "/driver/login.html";
            return;
        }

        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.removeItem("ft_access_token");
            localStorage.removeItem("ft_user");
            window.location.href = "/driver/login.html";
        });

        await loadDriverProfile(token);
    }

    async function loadDriverProfile(token) {
        const errorEl   = document.getElementById("driverProfileError");
        const infoEl    = document.getElementById("driverProfileInfo");
        const carEl     = document.getElementById("driverCarInfo");
        const statsEl   = document.getElementById("driverStats");
        const tripsEl   = document.getElementById("driverTrips");

        errorEl.textContent = "Загружаем данные профиля…";
        errorEl.style.color = "#e5e7eb";

        try {
            const res = await safeFetch("/api/driver/me", {
                headers: { "Authorization": "Bearer " + token }
            });

            if (!res) return; // safeFetch мог разлогинить и редиректнуть

            const json = await res.json().catch(() => ({}));

            if (!res.ok) {
                errorEl.textContent = json.error || "Не удалось загрузить профиль";
                errorEl.style.color = "#ef4444";
                return;
            }

            errorEl.textContent = "";

            const profile = json.profile || {};
            const stats   = json.stats || {};
            const trips   = json.trips || [];

            infoEl.innerHTML = `
                <p><span>Имя:</span> <strong>${profile.first_name || "—"}</strong></p>
                <p><span>Фамилия:</span> <strong>${profile.last_name || "—"}</strong></p>
                <p><span>Email:</span> <strong>${profile.email || "—"}</strong></p>
                <p><span>Телефон:</span> <strong>${profile.phone || "—"}</strong></p>
                <p><span>Класс:</span> <strong>${profile.driver_class || "—"}</strong></p>
            `;

            carEl.innerHTML = `
                <p><span>Марка:</span>  <strong>${profile.car_make   || "—"}</strong></p>
                <p><span>Модель:</span> <strong>${profile.car_model  || "—"}</strong></p>
                <p><span>Цвет:</span>   <strong>${profile.car_color  || "—"}</strong></p>
                <p><span>Гос. номер:</span> <strong>${profile.car_plate || "—"}</strong></p>
            `;

            const statsArr = [
                { label: "Всего поездок",     value: stats.total_trips ?? 0 },
                { label: "Поездок сегодня",   value: stats.today_trips ?? 0 },
                { label: "Общий доход, ₽",    value: stats.total_income ?? 0 },
                { label: "Средний рейтинг",   value: stats.rating != null
                                                ? stats.rating.toFixed(1)
                                                : "—" },
            ];
            statsEl.innerHTML = statsArr.map(s => `
                <div class="stat-card">
                    <div class="stat-card__label">${s.label}</div>
                    <div class="stat-card__value">${s.value}</div>
                </div>
            `).join("");

            if (!trips.length) {
                tripsEl.innerHTML = `<div class="history-item">Пока нет завершённых поездок</div>`;
            } else {
                tripsEl.innerHTML = trips.map(t => `
                    <div class="history-item">
                        <div class="history-item__top">
                            <span>${t.from}</span> → <span>${t.to}</span>
                        </div>
                        <div class="history-item__bottom">
                            <span>${t.date}</span>
                            <span>${t.price} ₽</span>
                        </div>
                    </div>
                `).join("");
            }
        } catch (err) {
            console.error(err);
            errorEl.textContent = "Ошибка сети при загрузке профиля";
            errorEl.style.color = "#ef4444";
        }
    }
</script>
</body>
</html>
