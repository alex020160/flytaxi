<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Рабочий экран — Водитель FlyTaxi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/assets/css/fonts.css">
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body class="driver-dashboard-body">
<div class="driver-layout">
    <!-- Левый вертикальный логотип -->
    <div class="driver-logo-vertical">
        <span>F</span>
        <span>L</span>
        <span>Y</span>
        <span>T</span>
        <span>A</span>
        <span>X</span>
        <span>I</span>
    </div>

    <!-- Правая часть -->
    <div class="driver-main-panel">
        <!-- Верхнее меню -->
        <div class="driver-top-nav">
            <a href="/driver/profile.html" class="driver-nav-link">Личный кабинет</a>
            <button id="driverLogoutBtn" class="driver-nav-link">Выйти</button>
        </div>

        <!-- Голубой блок с заказами -->
        <div class="driver-orders-wrapper">
            <div id="driverOrdersList" class="driver-orders-list"></div>
        </div>

        <!-- Нижняя область: заголовок + кнопка обновить + сообщение -->
        <div class="driver-bottom">
            <div class="driver-bottom-title">АКТУАЛЬНЫЕ ЗАКАЗЫ</div>
            <button id="refreshOrdersBtn" class="driver-refresh-btn">Обновить</button>
            <div id="ordersMessage" class="driver-message"></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("ft_access_token");
        const user  = JSON.parse(localStorage.getItem("ft_user") || "{}");

        if (!token || user.role !== "driver") {
            window.location.href = "/driver/login.html";
            return;
        }

        const list       = document.getElementById("driverOrdersList");
        const message    = document.getElementById("ordersMessage");
        const refreshBtn = document.getElementById("refreshOrdersBtn");

        let timers = {};

        // универсальный fetch с обработкой 401
        async function safeFetch(url, options) {
            const res = await fetch(url, options);

            if (res.status === 401) {
                localStorage.removeItem("ft_access_token");
                localStorage.removeItem("ft_user");
                window.location.href = "/driver/login.html";
                return null;
            }

            return res;
        }

        async function loadOrders() {
            message.textContent = "Загружаем заказы…";
            message.style.color = "#e5e7eb";

            try {
                const res = await safeFetch("/api/driver/orders", {
                    headers: { "Authorization": "Bearer " + token }
                });

                if (!res) return; // safeFetch мог уже сделать redirect

                const json = await res.json().catch(() => ({}));

                if (!res.ok) {
                    message.textContent = json.error || "Не удалось получить заказы";
                    message.style.color = "#ef4444";
                    return;
                }

                const orders = json.orders || [];
                renderOrders(orders);
                message.textContent = "";
            } catch (err) {
                console.error(err);
                message.textContent = "Ошибка сети при загрузке заказов";
                message.style.color = "#ef4444";
            }
        }

        function clearAllTimers() {
            Object.values(timers).forEach(id => clearInterval(id));
            timers = {};
        }

        // форматируем продолжительность по started_at/finished_at
        function formatDurationFromStrings(startStr, endStr) {
            const start = new Date(startStr);
            const end   = endStr ? new Date(endStr) : new Date();

            if (isNaN(start.getTime()) || isNaN(end.getTime()) || end <= start) {
                return "00:00:00";
            }

            const diffMs   = end.getTime() - start.getTime();
            const totalSec = Math.floor(diffMs / 1000);

            const h = String(Math.floor(totalSec / 3600)).padStart(2, "0");
            const m = String(Math.floor((totalSec % 3600) / 60)).padStart(2, "0");
            const s = String(totalSec % 60).padStart(2, "0");

            return `${h}:${m}:${s}`;
        }

        function renderOrders(orders) {
            clearAllTimers();
            list.innerHTML = "";

            if (!orders.length) {
                list.innerHTML = `<div class="driver-empty">Нет активных заказов</div>`;
                return;
            }

            orders.forEach(order => {
                const card = document.createElement("div");
                card.className = "driver-order-card";

                const minutes = order.eta_minutes || (10 + Math.floor(Math.random() * 111));

                // --- время в строке ---
                let timeText;
                if (order.status === "new") {
                    timeText = `${minutes} мин`;
                } else if (order.status === "finished" && order.started_at && order.finished_at) {
                    // фактическое время поездки
                    timeText = formatDurationFromStrings(order.started_at, order.finished_at);
                } else {
                    // assigned / in_progress – покажем 00:00:00, а для in_progress
                    // ниже запустим живой таймер
                    timeText = "00:00:00";
                }

                let actionsHtml = "";
                if (order.status === "new") {
                    actionsHtml = `
                        <button class="btn-accept" data-action="accept" data-id="${order.id}">Принять</button>
                        <button class="btn-reject" data-action="reject" data-id="${order.id}">Отказаться</button>
                    `;
                } else if (order.status === "assigned") {
                    actionsHtml = `
                        <button class="btn-accept" data-action="start" data-id="${order.id}">Начать поездку</button>
                        <button class="btn-reject" data-action="cancel" data-id="${order.id}">Отменить</button>
                    `;
                } else if (order.status === "in_progress") {
                    actionsHtml = `
                        <button class="btn-accept" data-action="finish" data-id="${order.id}">Завершить поездку</button>
                    `;
                } else if (order.status === "finished") {
                    const hasFeedback =
                        order.rating != null ||
                        order.tip_amount != null ||
                        (order.client_note && order.client_note.trim() !== "");

                    if (hasFeedback) {
                        actionsHtml = `
                            <button class="btn-accept" data-action="close" data-id="${order.id}">
                                Готово
                            </button>
                        `;
                    } else {
                        actionsHtml = `<div>Ожидаем оценку клиента…</div>`;
                    }
                }

                let ratingBlock = "";
                if (order.status === "finished" &&
                    (order.rating != null || order.tip_amount != null || order.client_note)) {
                    ratingBlock = `
                        <div class="driver-order-row">
                            <div class="driver-order-field">Оценка клиента:</div>
                            <div class="driver-order-value">
                                ${order.rating != null ? `${order.rating} / 5` : "—"}
                            </div>
                        </div>
                        <div class="driver-order-row">
                            <div class="driver-order-field">Чаевые:</div>
                            <div class="driver-order-value">
                                ${order.tip_amount != null ? `${order.tip_amount} ₽` : "0 ₽"}
                            </div>
                        </div>
                        <div class="driver-order-row">
                            <div class="driver-order-field">Комментарий:</div>
                            <div class="driver-order-value">
                                ${order.client_note || "—"}
                            </div>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="driver-order-row">
                        <div class="driver-order-field">Откуда:</div>
                        <div class="driver-order-value">${order.from}</div>
                    </div>
                    <div class="driver-order-row">
                        <div class="driver-order-field">Куда:</div>
                        <div class="driver-order-value">${order.to}</div>
                    </div>
                    <div class="driver-order-row">
                        <div class="driver-order-field">Класс авто:</div>
                        <div class="driver-order-value">${order.car_class_text || "Эконом"}</div>
                    </div>
                    <div class="driver-order-row">
                        <div class="driver-order-field">
                            ${
                                order.status === "assigned"
                                    ? "До клиента:"
                                    : order.status === "in_progress"
                                        ? "В пути:"
                                        : "Время в пути:"
                            }
                        </div>
                        <div class="driver-order-value">
                            <span class="timer"
                                  data-status="${order.status || ""}"
                                  data-id="${order.id}"
                                  data-start="${order.started_at || ""}">
                                ${timeText}
                            </span>
                        </div>
                    </div>
                    <div class="driver-order-row">
                        <div class="driver-order-field">Стоимость:</div>
                        <div class="driver-order-value">${order.price || "—"} ₽</div>
                    </div>
                    <div class="driver-order-row">
                        <div class="driver-order-field">Опции:</div>
                        <div class="driver-order-value">
                            ${order.with_pet ? "С питомцем" : ""}
                            ${order.with_booster ? (order.with_pet ? ", бустер" : "Бустер") : ""}
                            ${(!order.with_pet && !order.with_booster) ? "—" : ""}
                        </div>
                    </div>
                    <div class="driver-order-row">
                        <div class="driver-order-field">Комментарий:</div>
                        <div class="driver-order-value">${order.comment || "Нет"}</div>
                    </div>
                    ${ratingBlock}
                    <div class="driver-order-actions">
                        ${actionsHtml}
                    </div>
                `;

                list.appendChild(card);

                // живой таймер только для in_progress
                if (order.status === "in_progress" && order.started_at) {
                    const timerEl = card.querySelector(".timer");
                    startTimer(order.id, order.started_at, timerEl);
                }
            });
        }

        function startTimer(orderId, startDateStr, el) {
            const start = new Date(startDateStr);

            function tick() {
                const diffMs   = Date.now() - start.getTime();
                const totalSec = Math.max(0, Math.floor(diffMs / 1000));

                const h = String(Math.floor(totalSec / 3600)).padStart(2, "0");
                const m = String(Math.floor((totalSec % 3600) / 60)).padStart(2, "0");
                const s = String(totalSec % 60).padStart(2, "0");

                el.textContent = `${h}:${m}:${s}`;
            }

            tick();
            timers[orderId] = setInterval(tick, 1000);
        }

        // обработка кнопок на карточке
        list.addEventListener("click", async (e) => {
            const btn = e.target.closest("button[data-action]");
            if (!btn) return;

            const action  = btn.dataset.action;
            const orderId = btn.dataset.id;
            btn.disabled = true;

            try {
                let url = "";
                if (action === "accept") {
                    url = `/api/driver/orders/${orderId}/accept`;
                } else if (action === "reject" || action === "cancel") {
                    url = `/api/driver/orders/${orderId}/reject`;
                } else if (action === "start") {
                    url = `/api/driver/orders/${orderId}/start`;
                } else if (action === "close") {
                    url = `/api/driver/orders/${orderId}/close`;
                } else if (action === "finish") {
                    url = `/api/driver/orders/${orderId}/finish`;
                } else {
                    btn.disabled = false;
                    return;
                }

                const res  = await safeFetch(url, {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + token }
                });
                if (!res) return;

                const json = await res.json().catch(() => ({}));

                if (!res.ok) {
                    alert(json.error || "Не удалось изменить статус заказа");
                    return;
                }

                await loadOrders();
            } catch (err) {
                console.error(err);
                alert("Ошибка сети");
            } finally {
                btn.disabled = false;
            }
        });

        refreshBtn.addEventListener("click", loadOrders);

        document.getElementById("driverLogoutBtn").addEventListener("click", () => {
            localStorage.removeItem("ft_access_token");
            localStorage.removeItem("ft_user");
            window.location.href = "/driver/login.html";
        });

        loadOrders();
        setInterval(loadOrders, 20000);
    });
</script>
</body>
</html>
