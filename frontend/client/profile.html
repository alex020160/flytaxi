<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Личный кабинет — FlyTaxi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/assets/css/fonts.css">
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body class="page profile-page">
<div class="profile-layout">
    <!-- ВЕРХНИЙ БЛОК С КНОПКАМИ -->
    <div class="profile-topbar">
        <div class="profile-topbar__title">FlyTaxi</div>
        <div class="profile-topbar__actions">
            <a href="/client/order.html" class="btn btn--ghost btn--small">← Заказ такси</a>
            <button id="logoutBtn" class="btn btn--ghost btn--small">Выйти</button>
        </div>
    </div>

    <!-- ОСНОВНОЙ ЦЕНТРАЛЬНЫЙ БЛОК -->
    <section class="card card--wide profile-card-shell">
        <h1 class="card__title">Личный кабинет</h1>

        <div id="clientProfileError" class="login-info" style="margin-bottom:8px;"></div>

        <div class="profile-grid">
            <!-- Профиль -->
            <div class="profile-card">
                <h2 class="profile-card__title">Профиль</h2>
                <div id="clientProfileInfo" class="profile-card__body"></div>
            </div>

            <!-- Статистика поездок -->
            <div class="profile-card">
                <h2 class="profile-card__title">Статистика поездок</h2>
                <div class="stats-grid" id="clientStats"></div>
            </div>

            <!-- Последние поездки -->
            <div class="profile-card profile-card--wide">
                <h2 class="profile-card__title">Последние поездки</h2>
                <div id="clientTrips" class="history-list"></div>
            </div>
        </div>
    </section>
</div>

<script>
    document.addEventListener("DOMContentLoaded", initClientProfile);

    // общий safeFetch для клиента
    async function safeFetch(url, options) {
        const res = await fetch(url, options);

        if (res.status === 401) {
            localStorage.removeItem("ft_access_token");
            localStorage.removeItem("ft_user");
            window.location.href = "/client/login.html";
            return null;
        }

        return res;
    }

    async function initClientProfile() {
        const token = localStorage.getItem("ft_access_token");
        const user  = JSON.parse(localStorage.getItem("ft_user") || "{}");

        if (!token || user.role !== "client") {
            window.location.href = "/client/login.html";
            return;
        }

        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.removeItem("ft_access_token");
            localStorage.removeItem("ft_user");
            window.location.href = "/client/login.html";
        });

        const profileInfo = document.getElementById("clientProfileInfo");
        profileInfo.innerHTML = `
            <p><span>Имя:</span> <strong>${user.first_name || "—"}</strong></p>
            <p><span>Фамилия:</span> <strong>${user.last_name || "—"}</strong></p>
            <p><span>Email:</span> <strong>${user.email || "—"}</strong></p>
            <p><span>Телефон:</span> <strong>${user.phone || "—"}</strong></p>
        `;

        await loadClientRides(token);
    }

    async function loadClientRides(token) {
        const errorEl  = document.getElementById("clientProfileError");
        const statsEl  = document.getElementById("clientStats");
        const tripsEl  = document.getElementById("clientTrips");

        errorEl.textContent = "Загружаем поездки…";
        errorEl.style.color = "#e5e7eb";

        try {
            const res = await safeFetch("/api/client/rides", {
                headers: { "Authorization": "Bearer " + token }
            });
            if (!res) return;

            const json = await res.json().catch(() => ({}));

            if (!res.ok) {
                errorEl.textContent = json.error || "Не удалось получить поездки";
                errorEl.style.color = "#ef4444";
                return;
            }

            errorEl.textContent = "";

            const rides = json.rides || [];

            // ---- Статистика ----
            const totalTrips = rides.length;
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);

            let lastMonthTrips = 0;
            rides.forEach(r => {
                if (!r.date) return;
                const d = new Date(r.date);
                if (!isNaN(d) && d >= monthAgo) {
                    lastMonthTrips++;
                }
            });

            const stats = [
                { label: "Всего поездок",      value: totalTrips },
                { label: "За последний месяц", value: lastMonthTrips },
            ];

            statsEl.innerHTML = stats.map(s => `
                <div class="stat-card">
                    <div class="stat-card__label">${s.label}</div>
                    <div class="stat-card__value">${s.value}</div>
                </div>
            `).join("");

            // ---- История поездок ----
            if (!rides.length) {
                tripsEl.innerHTML = `<div class="history-item">Вы ещё не совершали поездок</div>`;
                return;
            }

            tripsEl.innerHTML = rides.map(t => `
                <div class="history-item">
                    <div class="history-item__top">
                        <span>${t.from}</span> → <span>${t.to}</span>
                    </div>
                    <div class="history-item__bottom">
                        <span>${t.date || ""}</span>
                        <span>${t.price} ₽</span>
                    </div>
                </div>
            `).join("");

        } catch (err) {
            console.error(err);
            errorEl.textContent = "Ошибка сети при загрузке поездок";
            errorEl.style.color = "#ef4444";
        }
    }
</script>
</body>
</html>
