<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Новый пароль — FlyTaxi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/assets/css/fonts.css">
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body class="page page--centered">

<div class="login-box">
    <h1 class="login-title">Установка нового пароля</h1>

    <form id="resetForm" class="login-form">
        <input class="input" type="email" name="email" id="emailInput" placeholder="Email" required>
        <input class="input" type="text" name="code" placeholder="Код из письма" required>
        <input class="input" type="password" name="new_password" placeholder="Новый пароль" required>
        <input class="input" type="password" name="new_password_confirm" placeholder="Повторите пароль" required>
        <button class="btn btn--client" type="submit">Сохранить пароль</button>
    </form>

    <p class="login-info" id="resetMessage"></p>

    <div class="login-links">
        <a class="login-back" href="login.html">← Назад к входу</a>
        <a class="login-back" href="/">← На главную</a>
    </div>
</div>

<script>
    // Подставляем email, если передали в query (?email=...)
    const params = new URLSearchParams(window.location.search);
    const emailFromQuery = params.get("email");
    if (emailFromQuery) {
      document.getElementById("emailInput").value = emailFromQuery;
    }

    const form = document.getElementById("resetForm");
    const message = document.getElementById("resetMessage");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (form.new_password.value !== form.new_password_confirm.value) {
        message.textContent = "Пароли не совпадают";
        message.style.color = "#ef4444";
        return;
      }

      const data = {
        email: form.email.value,
        code: form.code.value,
        new_password: form.new_password.value,
      };

      message.textContent = "Отправляем...";
      message.style.color = "#e5e7eb";

      try {
        const res = await fetch("/api/auth/reset-password", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(data)
        });

        const json = await res.json().catch(() => ({}));

        if (!res.ok) {
          message.textContent = json.error || "Ошибка при смене пароля";
          message.style.color = "#ef4444";
          return;
        }

        message.textContent = "Пароль успешно изменён. Сейчас вы будете перенаправлены на страницу входа.";
        message.style.color = "#22c55e";

        setTimeout(() => {
          window.location.href = "/client/login.html";
        }, 2000);

      } catch (err) {
        message.textContent = "Ошибка сети";
        message.style.color = "#ef4444";
      }
    });
</script>

</body>
</html>
